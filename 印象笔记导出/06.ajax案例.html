<html>
<head>
  <title>06.ajax案例</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307425 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1239"/>
<h1>06.ajax案例</h1>

<div>
<span><div><h6 style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; margin-top: 1rem; margin-bottom: 1rem; cursor: text; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; cursor: text; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; break-after: avoid-page; break-inside: avoid; color: rgb(119, 119, 119); font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 1.4;">案例：微博点赞</span></h6><div style="box-sizing: border-box; overflow: visible; white-space: normal; text-align: left; background-color: rgb(248, 248, 248); border: 1px solid rgb(223, 226, 229); border-radius: 3px; padding: 8px 1em 6px; margin-bottom: 15px; margin-top: 15px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; position: relative !important;"><div style="font-size: 0.9em;"><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//（html页面）1.发起ajax请求，将weibo.json的内容返回到页面</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">var xhr = new XMLHttpRequest();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">xhr.onreadystatechange = function(){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    if(xhr.readyState === 4 &amp;&amp; xhr.status === 200){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        var res = JSON.parse(xhr.responseText);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        ul.innerHTML = res.map(item=&gt;{</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            return `&lt;li data-id=&quot;${item.id}&quot;&gt;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            &lt;h4&gt;${item.username}&lt;/h4&gt;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            &lt;p&gt;${item.content}&lt;/p&gt;</font></span></div><div><font style="font-size: 11pt;"><span style="font-family: Consolas; color: rgb(51, 51, 51);">            &lt;span&gt;${</span><a href="http://item.comtcnt/" style="font-family: Consolas; color: rgb(51, 51, 51);">item.comtcnt</a><span style="font-family: Consolas; color: rgb(51, 51, 51);">}&lt;/span&gt;</span></font></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            &lt;span class=&quot;like&quot;&gt;${item.likecnt}&lt;/span&gt;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            &lt;/li&gt;`;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        }).join('');</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        datalist.appendChild(ul);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">xhr.open('get','../data/weibo.json',true);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">xhr.send();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//(html页面)2.点赞，获取到当前按钮对用的id，发送ajax请求，get方法通过url拼接参数传送id到后台。</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//随后php页面对json数据进行修改，再将当前被改变的对象返回。xhr对象通过responseText进行接收为字符串，转成对象，获取到linkcnt键对应的值，给当前事件源修改innerHTML。</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//考虑多次请求，可能存在缓存状态，所以补充若是status为304也为请求成功。</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">datalist.onclick = function(e){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    if(e.target.className === 'like'){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        // e.target.innerText = e.target.innerText*1+1;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        // 获取当前微博id</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        let currentLi = e.target.parentNode;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        let id = currentLi.dataset.id;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        let xhr = new XMLHttpRequest();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        let status = [200,304];</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        xhr.onreadystatechange = function(){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            if(xhr.readyState === 4 &amp;&amp; status.indexOf(xhr.status)&gt;=0){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">                let res = JSON.parse(xhr.responseText);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">                e.target.innerHTML = res.likecnt;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        xhr.open('get','../api/weibo.php?id='+id,true);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        xhr.send();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//（php）</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//1.接收前端传过来的id，返回值为字符串</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$id = isset($_GET['id']) ? $_GET['id'] : Null;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//2.打开json文件fopen()，读取json文件数据fread()。</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$path = '';//相对路径</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$file = fopen($path,&quot;r&quot;);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$content = fread($file,filesize($path));</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">fclose($file);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//2.对得到的content内容转成json数组后，遍历里面每个item对象，若id键对应的值等于传入的$id,将该对象的linkcnt++。</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$contentArr = json.decode($content);//此处contentArr为对象数组</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$res;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">foreach($contentArr as $item){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    //此处item为一个对象</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    if($item-&gt;id == $id){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        $item-&gt;linkcnt++;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        $res = $item;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//4.将contentArr转成字符串，重新写入json文件</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$file = fopen($path, 'w');</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">fwrite($file, json_encode($arr,JSON_UNESCAPED_UNICODE));</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">fclose($file);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//5.将步骤2声明变量res，将改变的item对象用res接收，转成字符串，echo给前端</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">echo json_encode($res,JSON_UNESCAPED_UNICODE);</font></span></div></div></div><h6 style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; margin-top: 1rem; margin-bottom: 1rem; cursor: text; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; cursor: text; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; break-after: avoid-page; break-inside: avoid; color: rgb(119, 119, 119); font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 1.4;">补充：eval的使用</span></h6><div style="box-sizing: border-box; overflow: visible; white-space: normal; text-align: left; background-color: rgb(248, 248, 248); border: 1px solid rgb(223, 226, 229); border-radius: 3px; padding: 8px 1em 6px; margin-bottom: 15px; margin-top: 15px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; position: relative !important;"><div style="font-size: 0.9em;"><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">var json = '{&quot;name&quot;:&quot;lemon&quot;,&quot;age&quot;:18}'; //标准json字符串</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">var json = '{&quot;name&quot;:&quot;lemon&quot;,\'age\':18}';//不标准</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">eval('('+json+')');//也可以转成对象</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">eval('1+2');//3</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">eval('定义函数；执行函数') //函数可以在字符串中执行</font></span></div></div></div><h6 style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; margin-top: 1rem; margin-bottom: 1rem; cursor: text; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; cursor: text; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; break-after: avoid-page; break-inside: avoid; color: rgb(119, 119, 119); font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 1.4;">讲解：ajax的来历及同源策略、同步异步</span></h6><h6 style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; margin-top: 1rem; margin-bottom: 1rem; cursor: text; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; cursor: text; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; break-after: avoid-page; break-inside: avoid; color: rgb(119, 119, 119); font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 1.4;">案例：用户名验证</span></h6><div style="box-sizing: border-box; overflow: visible; white-space: normal; text-align: left; background-color: rgb(248, 248, 248); border: 1px solid rgb(223, 226, 229); border-radius: 3px; padding: 8px 1em 6px; margin-bottom: 15px; margin-top: 15px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; position: relative !important;"><div style="font-size: 0.9em;"><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">username.onblur = function(){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    let _username = username.value;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    let status = [200,304];</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    let xhr = new XMLHttpRequest();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    //xhr.onload意思为数据请求完成后，等同于xhr.readystate==4的状态</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    xhr.onload = function(){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        if(status.includes(xhr.status)){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            let res = xhr.responseText;//fail,success</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            if(res === 'fail'){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">                username.nextElementSibling.innerHTML = `${_username}太受欢迎，你走吧`；</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            }else{</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">                username.nextElementSibling.innerHTML = `恭喜你绿了`；</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    xhr.open('get','../api/checkname.php?username='+_username,true);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    xhr.send();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//php</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//1.数组存放已经存在的用户名</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$userlist = array('张三','李四','王尼玛','奥巴马','laoxie','lemon');</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//2. 获取前端传来的用户名</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$username = isset($_GET['username']) ? $_GET['username'] : null;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//3. 判断前端传来的用户名是否已存在数组内</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">$res = in_array($username, $userlist);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">if($res){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    // 用户名已存在，注册失败</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    echo &quot;fail&quot;;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}else{</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    echo &quot;success&quot;;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div></div></div><h6 style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; margin-top: 1rem; margin-bottom: 1rem; cursor: text; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="box-sizing: border-box; orphans: 2; font-size: 1em; position: relative; cursor: text; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; break-after: avoid-page; break-inside: avoid; color: rgb(119, 119, 119); font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 1.4;">案例：分页数据加载</span></h6><div style="box-sizing: border-box; overflow: visible; white-space: normal; text-align: left; background-color: rgb(248, 248, 248); border: 1px solid rgb(223, 226, 229); border-radius: 3px; padding: 8px 1em 6px; margin-bottom: 15px; margin-top: 15px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; position: relative !important;"><div style="font-size: 0.9em;"><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//html页面：</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">var qty = 5;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">// 1.发起ajax请求数据，拿到返回的数据，转成对象。</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">let status = [200,304]</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">let xhr = new XMLHttpRequest();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">xhr.onload = function(){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    if(status.includes(xhr.status)){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        let res = JSON.parse(xhr.responseText);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        // 2.拿到对象的data键对应的值(为json字符串)，渲染页面</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        datalist.innerHTML= res.data.map(function(item){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            return `&lt;li&gt;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            &lt;h4&gt;${item.name}&lt;/h4&gt;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            &lt;div&gt;${item.content}&lt;/div&gt;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            &lt;/li&gt;`;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        }).join(&quot;&quot;);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        //3.得到总页码数pageNum，parseInt(数据总数res.total/每页数据qty).遍历生成页码</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        var pageNum = parseInt(res.total/res.qty);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        page.innerHTML = &quot;&quot;;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        for(var i=0;i&lt;pageNum;i++){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            var span = document.createElement(&quot;span&quot;);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            span.innerHTML = i+1;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            //5.拿到返回的当前页码-1，把当前索引设置高亮</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            var curidx = res.curpage -1;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            if(i == curidx){span.className = &quot;active&quot;;}</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">            page.appendChild(span);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        }</font></span></div><div><font style="font-size: 11pt;"><br style="font-family: Consolas; color: rgb(51, 51, 51);"/></font></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">xhr.open('get','../api/lemon.php?qty='+qty+'&amp;curpage=1',true);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">xhr.send();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">// 4.点击分页切换</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">page.onclick = function(e){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    if(e.target.tagName.toLowerCase() === 'span'){</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        let curpage = e.target.innerText;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        xhr.open('get','../api/lemon.php?qty='+qty+'&amp;curpage='+curpage,true);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        xhr.send();</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    }</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">//php：</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">&lt;?php</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $qty = isset($_GET[&quot;qty&quot;])? $_GET[&quot;qty&quot;] : 5;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $curpage = isset($_GET[&quot;curpage&quot;])? $_GET[&quot;curpage&quot;] : 1;</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    //1.拿到json数据,根据每页数量与当前页，裁切对应的数据</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $path = '../data/football.json';</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $file = fopen($path,'r');</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $content = fread($file,filesize($path));</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $data = json_decode($content);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $curdate = array_slice($data,$qty*($curpage-1),$qty);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    //2.格式化数据，再返回给前端</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    $res = array(</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        &quot;total&quot; =&gt; count($data),</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        &quot;data&quot; =&gt; $curdate,</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        &quot;qty&quot; =&gt; $qty*1,</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">        &quot;curpage&quot; =&gt; $curpage*1,</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    );</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">    echo json_encode($res,JSON_UNESCAPED_UNICODE);</font></span></div><div><span style="font-family: Consolas; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">?&gt;</font></span></div></div></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 